# n8n æºç æ„å»º Dockerfile (ä½¿ç”¨æœ¬åœ°ä¾èµ–ç¼“å­˜ç‰ˆæœ¬)
# ä¼˜åŒ–ï¼šå…ˆ COPY æœ¬åœ° pnpm-storeï¼Œé¿å…ç½‘ç»œä¸‹è½½å¡ä½
ARG NODE_VERSION=22.21.1
# --- æ„å»ºé˜¶æ®µ ---
FROM node:${NODE_VERSION}-alpine3.22 AS builder

# 1. å®‰è£…æ„å»ºåŸºç¡€ä¾èµ–
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories && \
    apk add --no-cache \
    git \
    python3 \
    make \
    g++ \
    libc6-compat \
    busybox-binsh \
    bash

# 2. é…ç½® Corepack å’Œ pnpm
RUN corepack enable && corepack prepare pnpm@10.22.0 --activate

# 3. è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
ENV DOCKER_BUILD=true
ENV pnpm_config_registry=https://registry.npmmirror.com
ENV NODE_ENV=production

WORKDIR /app

# 4. å¤åˆ¶ monorepo æ ¸å¿ƒé…ç½®æ–‡ä»¶
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json turbo.json .npmrc ./
COPY scripts/ ./scripts/
COPY patches/ ./patches/
COPY packages/ ./packages/

# ğŸ”¥ 5. å¤åˆ¶æœ¬åœ°é¢„ä¸‹è½½çš„ pnpm store åˆ°å®¹å™¨
COPY .pnpm-store /root/.local/share/pnpm/store

# 6. å®‰è£…ä¾èµ– (å…ˆè·³è¿‡ scriptsï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜)
# --ignore-scripts: è·³è¿‡ preinstall/postinstall ç­‰è„šæœ¬ï¼Œé¿å…ç¼ºå°‘ä¾èµ–å¯¼è‡´å¤±è´¥
# --offline: å¼ºåˆ¶ä½¿ç”¨æœ¬åœ° storeï¼Œå®Œå…¨ä¸è®¿é—®ç½‘ç»œ
RUN pnpm install --frozen-lockfile --offline --ignore-scripts

# 7. æ‰§è¡Œå¿…è¦çš„ rebuild (ä¸ºéœ€è¦ç¼–è¯‘çš„åŸç”Ÿæ¨¡å—)
# æ­¤æ—¶åŸºç¡€ä¾èµ–å·²å®‰è£…ï¼Œå¯ä»¥å®‰å…¨æ‰§è¡Œ rebuild
RUN pnpm rebuild

# 7. æ‰§è¡Œç¼–è¯‘ (ä½¿ç”¨ä¿®å¤åçš„è„šæœ¬)
COPY . .
RUN node scripts/build-n8n.mjs

# --- ç”Ÿäº§é˜¶æ®µ ---
FROM node:22-alpine

ARG N8N_VERSION=snapshot
ARG N8N_RELEASE_TYPE=dev

ENV NODE_ENV=production
ENV N8N_RELEASE_TYPE=${N8N_RELEASE_TYPE}
ENV N8N_VERSION=${N8N_VERSION}
ENV NODE_ICU_DATA=/usr/local/lib/node_modules/full-icu
ENV SHELL=/bin/sh

WORKDIR /home/node

# 1. å®‰è£… n8n è¿è¡Œæ—¶ä¾èµ–åŠ Python 3
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories && \
    apk add --no-cache \
    python3 \
    graphicsmagick \
    tini \
    tzdata \
    ca-certificates \
    libc6-compat \
    busybox-binsh && \
    npm install -g full-icu@1.5.0

# 2. ä» builder é˜¶æ®µå¤åˆ¶ç¼–è¯‘æˆæœ
COPY --from=builder /app/compiled /usr/local/lib/node_modules/n8n
COPY --from=builder /app/docker/images/n8n/docker-entrypoint.sh /

# 3. è¿è¡Œç¯å¢ƒé…ç½®
RUN cd /usr/local/lib/node_modules/n8n && \
    npm rebuild sqlite3 && \
    ln -s /usr/local/lib/node_modules/n8n/bin/n8n /usr/local/bin/n8n && \
    mkdir -p /home/node/.n8n && \
    chown -R node:node /home/node && \
    rm -rf /root/.npm /tmp/* /root/.cache

EXPOSE 5678/tcp
USER node
ENTRYPOINT ["tini", "--", "/docker-entrypoint.sh"]
